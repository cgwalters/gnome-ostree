From 0ee291dd4fa73fbffb1f2ad571688440324564b3 Mon Sep 17 00:00:00 2001
From: Colin Walters <walters@verbum.org>
Date: Fri, 27 Apr 2012 18:34:39 -0400
Subject: [PATCH 1/6] Add --with-default-pam-config option, autodetect from
 /etc/foo-release files

The PAM files that ship with GDM are really specific to Red Hat's
historical fork of pam.  For example, the "system-auth" file still
lives in the Fedora 17 "pam" git.  A long while back, Debian hit the
same problem, and of course the difference is the naming;
common-auth/common-password etc.

OpenEmbedded then picked up Debian's PAM fork.  Since for OSTree-GNOME
we're using Poky/OpenEmbedded, let's add an option to integrate with
their PAM.

We use code similar to what NetworkManager has, so we should keep
using the Red Hat files on systems with /etc/redhat-release or
/etc/fedora-release.

https://bugzilla.gnome.org/show_bug.cgi?id=675085
---
 configure.ac                        |   22 ++++++++++++++++++++++
 data/Makefile.am                    |   33 +++++++++++++++++++++------------
 data/gdm                            |   12 ------------
 data/gdm-autologin                  |   10 ----------
 data/gdm-welcome                    |    9 ---------
 data/pam-openembedded/gdm           |   12 ++++++++++++
 data/pam-openembedded/gdm-autologin |   10 ++++++++++
 data/pam-openembedded/gdm-welcome   |    9 +++++++++
 data/pam-redhat/gdm                 |   12 ++++++++++++
 data/pam-redhat/gdm-autologin       |   10 ++++++++++
 data/pam-redhat/gdm-welcome         |    9 +++++++++
 11 files changed, 105 insertions(+), 43 deletions(-)
 delete mode 100644 data/gdm
 delete mode 100644 data/gdm-autologin
 delete mode 100644 data/gdm-welcome
 create mode 100644 data/pam-openembedded/gdm
 create mode 100644 data/pam-openembedded/gdm-autologin
 create mode 100644 data/pam-openembedded/gdm-welcome
 create mode 100644 data/pam-redhat/gdm
 create mode 100644 data/pam-redhat/gdm-autologin
 create mode 100644 data/pam-redhat/gdm-welcome

diff --git a/configure.ac b/configure.ac
index 81ea23e..fdd4676 100644
--- a/configure.ac
+++ b/configure.ac
@@ -226,6 +226,27 @@ if test x$enable_split_authentication = xyes; then
   AC_DEFINE(ENABLE_SPLIT_AUTHENTICATION, 1, [Define if split authentication is enabled])
 fi
 
+AC_ARG_WITH(default-pam-config,
+	    AS_HELP_STRING([--with-default-pam-config: One of redhat, openembedded, none @<:@default=auto@:>@]))
+dnl If not given, try autodetecting from release files (see NetworkManager source) 
+if test x$with_default_pam_config = x; then
+	AC_CHECK_FILE(/etc/redhat-release,with_default_pam_config="redhat")
+	AC_CHECK_FILE(/etc/fedora-release,with_default_pam_config="redhat")
+	dnl If not autodetected, default to none
+	if test x$with_default_pam_config = x; then
+	  with_default_pam_config=none
+	fi
+fi
+case x$with_default_pam_config in
+     xredhat|xopenembedded|xnone) ;;
+     *)
+       AC_MSG_ERROR([Invalid --with-default-pam-config ${with_default_pam_config}])
+       exit 1
+       ;;
+esac
+AM_CONDITIONAL(ENABLE_REDHAT_PAM_CONFIG, test x$with_default_pam_config = xredhat)
+AM_CONDITIONAL(ENABLE_OPENEMBEDDED_PAM_CONFIG, test x$with_default_pam_config = xopenembedded)
+
 AC_ARG_ENABLE(console-helper,
 	      AS_HELP_STRING([--enable-console-helper],
                              [Enable PAM console helper @<:@default=auto@:>@]),,
@@ -1550,6 +1571,7 @@ echo "
 
         dbus-1 system.d dir:      ${DBUS_SYS_DIR}
         PAM prefix:               ${PAM_PREFIX}
+        PAM config:               ${with_default_pam_config}
         X server:                 ${X_SERVER}
 "
 
diff --git a/data/Makefile.am b/data/Makefile.am
index f0d00bf..9c8379b 100644
--- a/data/Makefile.am
+++ b/data/Makefile.am
@@ -1,5 +1,6 @@
 NULL =
 
+EXTRA_DIST =
 SUBDIRS =			\
 	applications		\
 	pixmaps			\
@@ -97,7 +98,19 @@ gdm-smartcard: gdm-smartcard.pam
 pamdir = $(PAM_PREFIX)/pam.d
 pam_DATA = gdm-fingerprint gdm-smartcard
 
-EXTRA_DIST =			\
+pam_redhat_files = pam-redhat/gdm pam-redhat/gdm-autologin pam-redhat/gdm-welcome
+EXTRA_DIST += $(pam_redhat_files)
+pam_openembedded_files = pam-openembedded/gdm pam-openembedded/gdm-autologin pam-openembedded/gdm-welcome
+EXTRA_DIST += $(pam_openembedded_files)
+
+if ENABLE_REDHAT_PAM_CONFIG
+pam_files = $(pam_redhat_files)
+endif
+if ENABLE_OPENEMBEDDED_PAM_CONFIG
+pam_files = $(pam_openembedded_files)
+endif
+
+EXTRA_DIST +=			\
 	$(schemas_in_files)	\
 	$(schemas_DATA)		\
 	$(dbusconf_in_files)	\
@@ -105,9 +118,6 @@ EXTRA_DIST =			\
 	gdm.schemas.in.in	\
 	gdm.conf-custom.in 	\
 	Xsession.in 		\
-	gdm 			\
-	gdm-autologin 		\
-	gdm-welcome 		\
 	gdm-fingerprint.pam	\
 	gdm-smartcard.pam	\
 	gdm-fallback.session	\
@@ -233,14 +243,13 @@ install-data-hook: gdm.conf-custom Xsession Init PostSession PreSession 00-upstr
 		$(mkinstalldirs) $(DESTDIR)$(PAM_PREFIX)/pam.d; \
 		chmod 755 $(DESTDIR)$(PAM_PREFIX)/pam.d; \
 	   fi; \
-	   if test $$system = Linux && test '!' -f $(DESTDIR)$(PAM_PREFIX)/pam.d/gdm; then \
-		$(INSTALL_DATA) $(srcdir)/gdm $(DESTDIR)$(PAM_PREFIX)/pam.d/gdm; \
-	   fi; \
-	   if test $$system = Linux && test '!' -f $(DESTDIR)$(PAM_PREFIX)/pam.d/gdm-autologin; then \
-		$(INSTALL_DATA) $(srcdir)/gdm-autologin $(DESTDIR)$(PAM_PREFIX)/pam.d/gdm-autologin; \
-	   fi; \
-	   if test $$system = Linux && test '!' -f $(DESTDIR)$(PAM_PREFIX)/pam.d/gdm-welcome; then \
-		$(INSTALL_DATA) $(srcdir)/gdm-welcome $(DESTDIR)$(PAM_PREFIX)/pam.d/gdm-welcome; \
+	   if test $$system = Linux; then \
+	     for file in $(pam_files); do \
+               bn=$$(basename $$file); \
+	       if test '!' -f $(DESTDIR)$(PAM_PREFIX)/pam.d/$$bn; then \
+		 $(INSTALL_DATA) $(srcdir)/$$file $(DESTDIR)$(PAM_PREFIX)/pam.d/$$bn; \
+	       fi; \
+	     done; \
 	   fi; \
 	   if test $$system = SunOS; then \
 		echo "Please add PAM authentication for gdm, gdm-autologin and gdm-welcome in $(PAM_PREFIX)/pam.conf!"; \
diff --git a/data/gdm b/data/gdm
deleted file mode 100644
index 58c397d..0000000
--- a/data/gdm
+++ /dev/null
@@ -1,12 +0,0 @@
-#%PAM-1.0
-auth       required    pam_env.so
-auth       required    pam_succeed_if.so user != root quiet
-auth       sufficient  pam_succeed_if.so user ingroup nopasswdlogin
-auth       include     system-auth
-account    required    pam_nologin.so
-account    include     system-auth
-password   include     system-auth
-session    optional    pam_keyinit.so force revoke
-session    include     system-auth
-session    required    pam_loginuid.so
-session    optional    pam_console.so
diff --git a/data/gdm-autologin b/data/gdm-autologin
deleted file mode 100644
index c4e598a..0000000
--- a/data/gdm-autologin
+++ /dev/null
@@ -1,10 +0,0 @@
-#%PAM-1.0
-auth       required    pam_env.so
-auth       required    pam_permit.so
-account    required    pam_nologin.so
-account    include     system-auth
-password   include     system-auth
-session    optional    pam_keyinit.so force revoke
-session    include     system-auth
-session    required    pam_loginuid.so
-session    optional    pam_console.so
diff --git a/data/gdm-welcome b/data/gdm-welcome
deleted file mode 100644
index b301f4f..0000000
--- a/data/gdm-welcome
+++ /dev/null
@@ -1,9 +0,0 @@
-#%PAM-1.0
-auth       required    pam_env.so
-auth       required    pam_permit.so
-account    required    pam_nologin.so
-account    include     system-auth
-password   include     system-auth
-session    required    pam_loginuid.so
-session    optional    pam_keyinit.so force revoke
-session    include     system-auth
diff --git a/data/pam-openembedded/gdm b/data/pam-openembedded/gdm
new file mode 100644
index 0000000..de223de
--- /dev/null
+++ b/data/pam-openembedded/gdm
@@ -0,0 +1,12 @@
+#%PAM-1.0
+auth       required    pam_env.so
+auth       required    pam_succeed_if.so user != root quiet
+auth       sufficient  pam_succeed_if.so user ingroup nopasswdlogin
+auth       include     common-auth
+account    required    pam_nologin.so
+account    include     common-account
+password   include     common-password
+session    optional    pam_keyinit.so force revoke
+session    include     common-session
+session    required    pam_loginuid.so
+session    optional    pam_console.so
diff --git a/data/pam-openembedded/gdm-autologin b/data/pam-openembedded/gdm-autologin
new file mode 100644
index 0000000..32d5248
--- /dev/null
+++ b/data/pam-openembedded/gdm-autologin
@@ -0,0 +1,10 @@
+#%PAM-1.0
+auth       required    pam_env.so
+auth       required    pam_permit.so
+account    required    pam_nologin.so
+account    include     common-auth
+password   include     common-auth
+session    optional    pam_keyinit.so force revoke
+session    include     common-session
+session    required    pam_loginuid.so
+session    optional    pam_console.so
diff --git a/data/pam-openembedded/gdm-welcome b/data/pam-openembedded/gdm-welcome
new file mode 100644
index 0000000..602217b
--- /dev/null
+++ b/data/pam-openembedded/gdm-welcome
@@ -0,0 +1,9 @@
+#%PAM-1.0
+auth       required    pam_env.so
+auth       required    pam_permit.so
+account    required    pam_nologin.so
+account    include     common-account
+password   include     common-auth
+session    required    pam_loginuid.so
+session    optional    pam_keyinit.so force revoke
+session    include     common-session
diff --git a/data/pam-redhat/gdm b/data/pam-redhat/gdm
new file mode 100644
index 0000000..58c397d
--- /dev/null
+++ b/data/pam-redhat/gdm
@@ -0,0 +1,12 @@
+#%PAM-1.0
+auth       required    pam_env.so
+auth       required    pam_succeed_if.so user != root quiet
+auth       sufficient  pam_succeed_if.so user ingroup nopasswdlogin
+auth       include     system-auth
+account    required    pam_nologin.so
+account    include     system-auth
+password   include     system-auth
+session    optional    pam_keyinit.so force revoke
+session    include     system-auth
+session    required    pam_loginuid.so
+session    optional    pam_console.so
diff --git a/data/pam-redhat/gdm-autologin b/data/pam-redhat/gdm-autologin
new file mode 100644
index 0000000..c4e598a
--- /dev/null
+++ b/data/pam-redhat/gdm-autologin
@@ -0,0 +1,10 @@
+#%PAM-1.0
+auth       required    pam_env.so
+auth       required    pam_permit.so
+account    required    pam_nologin.so
+account    include     system-auth
+password   include     system-auth
+session    optional    pam_keyinit.so force revoke
+session    include     system-auth
+session    required    pam_loginuid.so
+session    optional    pam_console.so
diff --git a/data/pam-redhat/gdm-welcome b/data/pam-redhat/gdm-welcome
new file mode 100644
index 0000000..b301f4f
--- /dev/null
+++ b/data/pam-redhat/gdm-welcome
@@ -0,0 +1,9 @@
+#%PAM-1.0
+auth       required    pam_env.so
+auth       required    pam_permit.so
+account    required    pam_nologin.so
+account    include     system-auth
+password   include     system-auth
+session    required    pam_loginuid.so
+session    optional    pam_keyinit.so force revoke
+session    include     system-auth
-- 
1.7.7.6

